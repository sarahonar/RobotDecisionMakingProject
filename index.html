<!DOCTYPE html>

<html>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script> 

<head>
<title>Control Barrier Functions</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">

</head>
    <style>
        /* CSS for text justification */
        .justified-text {
            text-align: justify;
        }

        /* CSS for adjusting text size, width, and length */
        .large-text {
            font-size: 24px; /* Adjust the font size as needed */
            width: 60%; /* Adjust the width as a percentage of the parent container */
            max-width: 500px; /* Set a maximum width to limit text length */
            margin: 0 auto; /* Center the text horizontally */
        }
    </style>
	
	<h1> Control Barrier Functions
		<h2>CMSC818B : Mini-Project 1 </h2>
  <h3>Team members: Sara Honarvar, Suraj Raval </h3> 
<hr> 		
 <h2>Summary</h2>
<p> Autonomous systems encounter significant challenges when operating in uncertain and unstructured dynamic environments. To safely navigate through such environments with unpredictable obstacles, robust decision-making capabilities are essential. In control theory, various certificate functions, such as Lyapunov functions, the barrier function, and the contraction metric, play critical roles in ensuring system stability and safety. These certificate functions have been proposed to prove certain desirable properties for the system.</p>
<p>Lyapunov functions, in nonlinear control for instance, certify system stability around a fixed point, which is an equilibrium point representing the desired state that you want your system to stay at. The barrier function is a generalized Lyapunov function that extends this concept to an invariant set, ensuring the safety of the system. Invariant denotes something that doesn't change. In simpler terms, if the system starts within this set, it remains within it. When this set happens to represent the safety zone, it ensures safety, particularly in the context of safe navigation. Additionally, there is the contraction metric, which can be viewed as a differentiable version of Lyapunov. It not only certifies contraction towards an equilibrium point but also ensures that the system remains close to the reference path, even in dynamic scenarios, provided the path is feasible. This blog primarily focuses on control barrier functions CBFs.</p>
<h4>Remark:</h4>
<p> The term stability refers to guiding a system to a point or within a defined set, while safety revolves around ensuring that the system remains within the boundaries of an invariant set, meaning it does not exit a safe region.</p>


</body>
<h2> Formal Definitions</h2>
<p> The concept of safety in control systems was first introduced through the concept of set invariance proposed by Nagumo as follows [1]:</p>
<p>Consider a nonlinear, closed dynamical system (i.e., system without input) of form \(\dot{x} = f(x)\), with \(x \in \mathbb{R}^n\). </p>
	<p>Let the safe set be \(C =\{ x \in \mathbb{R}^n: h(x) \geq 0 \}\). Assuming that \(\frac{\partial h}{\partial x} \neq 0\), \(\forall x\), such that \(h(x) = 0\) where \(h : \mathbb{R}^n \rightarrow \mathbb{R}\) is a <cite><a href="https://en.wikipedia.org/wiki/Smoothness">smooth function</a></cite> (i.e., continously differentiable).</p>
	<p>Then according to Nagumo's theorem, the necessary and sufficient condition for set invariance is given based on the derivative of \(h\) on the boundary of \(C\): \[C \text{ is invariant} \iff L_fh(x) \geq 0 \text{ for all } x \in \partial C\]
\(L_fh(x) = \frac{\partial {h}}{\partial{x}}(x) f(x)\) is the Lie-derivative of \(h(x)\) along \(f(x)\). The above definition lays foundation for all barrier functions and has been rediscovered in different forms. </p>
	<h3> Barrier Certificates</h3>
 <p> Barrier Certificates are formal methods used to ensure the safety of nonlinear and hybrid systems, often connected to the principles of Nagumo's theorem. The term "barrier" originates from the field of optimization, where it denotes elements added to cost functions to prevent undesirable regions. 
 In the context of barrier certificates, assuming the function \( B: \mathbb{R}^n \rightarrow \mathbb{R}\), where \( \begin{cases}B(x) \leq 0 & \forall x \in C_0\\ B(x) > 0 & \forall x \in C_u\end{cases}\),
	where \(C_u\) is the unsafe set, and \(C_0\) is a set of initial conditions. Then \(B\) is a barrier certificate if 
	\[ L_fB(x)\leq 0  \rightarrow C \text{ is invariant}.\]</p>
	<p> \(L_fB(x) = \frac{\partial {B}}{\partial{x}}(x) f(x)\) is the Lie-derivative of \(B(x)\) along \(f(x)\). Besides, the above result can be reduced to Nagumo's theorem by setting the safe set to be the complement of the unsafe set (i.e., \(C=C_u^c\)) and \(B(x)=-h(x)\).</p>
	<!--<h3>Barrier Lyapunov function</h3>
		<p> Barrier Certificates ensure safety over the boundary of a set, while Barrier Lyapunov functions, \(B\) extend safety guarantees over the entire set. To ensure safety, \(B\) must be positive definite at all points within the set. By enforcing \(\dot{B}(x)\leq 0\) over the set \(C\), Barrier Lyapunov functions guarantee the invariance of set \(C\), and thus saftey across the entire region. However, the condition is conservative, as it enforce the invariance of every level set.  </p> -->
	In order to extend the results to nonlinear open dynamical systems or nonlinear input affine systems, e.g.,
		\(\dot{x}=f(x)+g(x)u\) for \(u \in U \subset \mathbb{R}^m\) is the set of admissible inputs, the concept of CBF was defined. In this case, the formulation leads from invariat sets to controlled invariant sets, i.e., the sets that can be made invariant by designing a proper controller. The concept of CBF is inspired by control Lyapunov functions (CLF). So before mathematically formalizing CBF, we start by introducing CLF. 
	<h3> Control Lyapunov function (CLF) </h3>
	<p>In control theory, Control Lyapunov Functions (CLFs) play a critical role in ensuring the stability of the system.</p>
		<p>Consider the following nonlinear control affine system \[\begin{equation}\dot{x}=f(x)+g(x)u\end{equation},\] 
		where \(u\) belongs to the admissible input set \(U \subset \mathbb{R}^m\), and \(f\) and \(g\) are locally Lipschitz functions. The state variable \(x\) resides in the domain \(D \subset \mathbb{R}^n\). 
			Suppose that the control objective for this system is to derive \(x(t)\rightarrow 0\), effectively stabilizing the system to \(x^*(t)=0\). Lyapunov's theory asserts that this objective can be achieved if there exists 
			a positive definite function \(V\) that satisfies the following constraint:
			\[\begin{equation}{\label{system dynamics}} inf_{u \in U}[L_fV(x)+L_gV(x)u]\leq -\gamma (V(x))\end{equation},\]
			where \(\gamma\) is a class <a href="https://en.wikipedia.org/wiki/Class_kappa_function">\(\kappa\) function</a> (i.e., \(\gamma(0)=0\) and 
				is strictly increasing). The function \(V\) is called the Control Lyapunov function (CLF). The above constraint guarantees that the time derivative of \(V\) along system trajectories is always non-positive. So, any Lipschitz continuous feedback controller \(u(x) \in K_{clf}(x):=\{u \in U[L_fV(x)+L_gV(x)u]\leq -\gamma (V(x))\}\) asymptotically steers the system towards \(x^*(t)=0\).</p>
		
	<h3> Control Barrier Functions (CBF)</h3>
		<p>In control theory, control barrier functions (CBFs) provide formal guarantees that a dynamical system will remain within a defined safe operating space. By constraining a barrier function to be nonnegative, CBFs ensure a system avoids entering undesirable or unsafe states during operation. For example, CBFs could keep a robot from getting too close to the edge of a table, or keep a vehicle from getting near the shoulder of a road. They provide a way to mathematically box a system into making only safe decisions. </p>
		<p> Building upon the barrier certificates definition and inspired by the CLFs, CBFs can be defined. A control barrier function \(h: \mathbb{R}^n \rightarrow \mathbb{R}\) is a continuously differentiable function that satisfies the following conditions
		\[\begin{cases}h(x)\leq 0 & x\in C \\ h(x) > 0 & x\in C_u \\ inf_{u \in U}[L_fh(x)+L_gh(x)u+\alpha (h(x))] \leq 0\end{cases}\]
		Note that \(C\) and \(C_u\) are the safe set and unsafe set, respectively and \(\alpha\) is a class \(\kappa\) function. The barrier is at \(h(x)=0\), and the first two conditions act like a classifier, distinguishing between safe and unsafe regions. The last condition sets CBFs apart from barrier certificates and aligns with the CLF, by ensuring that the Lie-derivative of \(h\) is negative. Additionally, \(\alpha\) intuitively enforces that if the goal is too close to the barrier and the robot is far from the goal, the robot can approach it. However, if the robot gets too close to the barrier, it prompts the robot to stop.
		</p>
	<h3> Graph Control Barrier Functions (GCBF)</h3>
	<p>In the context of multi-agent systems (MAS), a variant of barrier certificates has been recently introduced. Consider the problem of designing a distributed control law that drives \(N\) agents, \(V_a=\{1,\dots,N\}\) to their goal locations while avoiding collisions. 
	Consider the agent's dynamics is given by \(\dot{x}=f_i(x)\), where \(x_i \in \mathbb{R}^n\) and \(u \in \mathbb{R}^m\), and \(f_i\) is locally Lipschitz continuous. The structure of system could be represented as a graph, \(G=(V,E\), with \(V\) is the node set and \(E = \{(i, j)\}\) is the set of edges representing the flow of information from node j to i.
	A GCBF for a graph is defined as \[\begin{cases}h(e_i,v_i)> 0 & x\in C_i \\ h(e_i,v_i) < 0 & x\in C_u \\ sup_{u_i}[\dot{h}(e_i,v_i)+\alpha (h(e_i,v_i))]\geq 0  & x\in C_i\end{cases}.\]
	Again \(\alpha\) is a class \(\kappa\) function. 
	<h2>How To Construct CBFs? </h2>
	<p> Constructing CBFs can be a challenging task. Traditional methods involve hand-crafted design which often requires expertise in control theory and a deep understanding of the specific system being controlled. Fixed-degree polynomials and exponential functions are among traditional methods for desigining CBFs, however, fine tuning the parameters of these functions may not be trivial. To overcome this, CBF synthesis can be formulated as an optimization problem over a space of continuously differentiable functions. For example, recently, convex optimization problems through sum of squares have been used to construct CBFs for systems with polynomial dynamics. However, these method may not scale well for high dimensional and nonlinear systems such as multi agent systems. Additionally, they are limited to polynomial systems and become nonconvex when jointly optimizing for the controller and CBF. To improve scalability and flexibility to more general system dynamics, machine learning techniques such as neural networks (NN), reinforcement learning (RL), and learning from demonstration have been deployed to approximate CBFs. These data-driven methods can overcome the limitations of analytic CBF design. </p>
	<p> CBFs learned through NN are called neural certificates. To satisfy the continuously differentiable assumption on \(h\), the CBFs are learned using continuously differentiable activation functions such as tanh, softplus for continous-time systems and ReLU for discrete-time case.</p>
		<p> To learn the certificate, \(h\), and controller, \(u\), simultaneously, two separate networks could be used, one for learning the control policy and the pther to learn the certificate.</p>
 </p>
	<p> For example, \(h\) and \(u\) can be derived by NN by assuming the following loss function:
	\[inf_{h,u}\left(sup_{x \in C}\left(max\left(0,h(x)\right)\right)+(sup_{x \in C_u}\left(max\left(0,-h(x)\right)\right)+(sup_{x}\left(max\left(0,[L_fh(x)+L_gh(x)u+\alpha (h(x))]\right)\right)\right).\]</p>	
	It has been recently shown that GCBF can be derived using graph neural network.
	</p>
		<!--<h2>Applications</h2>-->
		
		<!--<h3> Single-Agent Systems </h3>-->
		
		<!--<h3> Multi-Agent Systems </h3>-->
		<h2> Open Research Questions </h2>
		<p> Currently, the process of training a neural certificate from training data has no theoretical gurantess on the lower bound for the amount of training data required for general non-linear systems. Although there have been some analytical results restricted to systems that are known a priori to be stable. </p>
		<p> Additionally, currently the theoretical probabilistic upper bounds on generalization error for a learned certificate are very condervative. A learned certificate's generalization error refers to its performance in the entire state-space of the system, compared to the performance on the training data. </p>
		<p> Learning certificates for heterogeneous multiagent systems is yet another challenging problem and it would have direct impact on deployment of multiagent robotic systems in the real-world. </p>
		<p> For the work that involves implementation on real robots in the real world, in addition to the constraints imposed by CLF and CBF, generally there is an input constraint which is necessary in order to make sure the input is admissible. In some works on deriving CLF and CBF, this input constraint is not taken into account, and hence the algorithm might not be deployable in the real world due to the physical input limitations of the system. There is potential in combining CLF and CBF constraints with the QP input constraints in order to provide practical uses of the results. </p>
		
		<h2>References</h2>
    <ol>
	<li><a href="https://arxiv.org/abs/1903.11199">Control Barrier Functions: Theory and Applications</a></li>
        <li><a href="https://en.wikipedia.org/wiki/Smoothness">Smoothness - Wikipedia</a></li>
	<li><a href="https://en.wikipedia.org/wiki/Class_kappa_function">Class_kappa_function- Wikipedia</a></li>
	<li><a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=10015199">Safe Control With Learned Certificates: A Survey of Neural Lyapunov, Barrier, and Contraction Methods for Robotics and Control</a></li>
        <li><a href="https://ieeexplore.ieee.org/abstract/document/9303785">Learning Control Barrier Functions from Expert Demonstrations</a></li>
	<li><a href="https://openreview.net/pdf?id=VscdYkKgwdH"> Neural Graph Control Barrier Functions Guided Distributed Collision-avoidance Multi-agent Control</li>
	<!-- Add more references here -->
    </ol>
</html>
